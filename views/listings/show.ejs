<% layout("layouts/boilerplate") %>

<div class="container my-5">
  <div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/listings" class="text-decoration-none">Listings</a></li>
          <li class="breadcrumb-item active" aria-current="page"><%= listing.title %></li>
        </ol>
      </nav>

      <!-- Listing Title -->
      <div class="mb-4">
        <h1 class="display-5 fw-bold text-gradient mb-2"><%= listing.title %></h1>
        <div class="d-flex align-items-center gap-3 text-muted">
          <span><i class="fas fa-map-marker-alt me-1"></i><%= listing.location %>, <%= listing.country %></span>
          <span><i class="fas fa-star text-warning me-1"></i>4.8 (24 reviews)</span>
          <span><i class="fas fa-user me-1"></i>Hosted by <%= listing.owner.username %></span>
        </div>
      </div>

      <!-- Main Image -->
      <div class="position-relative mb-4">
        <img src="<%= listing.image.url %>" alt="<%= listing.title %>" class="listing-image w-100 rounded-4 shadow-lg">
        <div class="position-absolute top-0 end-0 m-3">
          <button class="btn btn-light btn-lg rounded-circle shadow like-btn" id="likeBtn" title="Like this listing" data-listing-id="<%= listing._id %>" data-liked="<%= currUser && listing.likes && listing.likes.some(like => like.equals(currUser._id)) ? 'true' : 'false' %>">
            <i class="fas fa-heart <%= currUser && listing.likes && listing.likes.some(like => like.equals(currUser._id)) ? 'text-danger' : 'text-muted' %>" id="likeIcon"></i>
          </button>
        </div>
        <div class="position-absolute bottom-0 start-0 m-3">
          <span class="badge bg-primary bg-opacity-90 rounded-pill fs-6 px-3 py-2">
            <i class="fas fa-star me-1"></i>Featured
          </span>
        </div>
      </div>

      <!-- Listing Details -->
      <div class="row g-4 mb-5">
        <div class="col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
              <h5 class="card-title text-primary mb-3">
                <i class="fas fa-info-circle me-2"></i>About this place
              </h5>
              <p class="card-text text-muted"><%= listing.description %></p>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body p-4">
              <h5 class="card-title text-primary mb-3">
                <i class="fas fa-map-marked-alt me-2"></i>Location
              </h5>
              <div class="d-flex flex-column gap-2">
                <div class="d-flex align-items-center">
                  <i class="fas fa-map-marker-alt text-danger me-2"></i>
                  <span><%= listing.location %></span>
                </div>
                <div class="d-flex align-items-center">
                  <i class="fas fa-flag text-success me-2"></i>
                  <span><%= listing.country %></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Owner Actions -->
      <% if (currUser && currUser._id.equals(listing.owner._id)) { %>
        <div class="card border-0 shadow-sm mb-5">
          <div class="card-body p-4">
            <h5 class="card-title text-primary mb-3">
              <i class="fas fa-cog me-2"></i>Manage Listing
            </h5>
            <div class="d-flex gap-3">
              <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">
                <i class="fas fa-edit me-2"></i>Edit Listing
              </a>
              <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="d-inline">
                <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this listing?')">
                  <i class="fas fa-trash me-2"></i>Delete Listing
                </button>
              </form>
            </div>
          </div>
        </div>
      <% } %>

      <!-- Review Form -->
      <% if (currUser) { %>
        <div class="card border-0 shadow-sm mb-5">
          <div class="card-body p-4">
            <h5 class="card-title text-primary mb-3">
              <i class="fas fa-comment me-2"></i>Leave a Review
            </h5>
            <form action="/listings/<%= listing._id %>/reviews" method="POST" class="needs-validation" novalidate>
              <div class="mb-3">
                <label for="comment" class="form-label fw-semibold">Your Review</label>
                <textarea 
                  class="form-control" 
                  id="comment" 
                  name="review[comment]" 
                  rows="4" 
                  required 
                  placeholder="Share your experience with this place..."
                ></textarea>
                <div class="invalid-feedback">Please enter your review.</div>
              </div>

              <div class="mb-4">
                <label class="form-label fw-semibold">Rating</label>
                <div class="starability-slot">
                  <input type="radio" id="no-rate" class="input-no-rate" name="review[likes]" value="1" checked aria-label="No rating." />
                  <input type="radio" id="first-rate1" name="review[likes]" value="1" required />
                  <label for="first-rate1" title="Terrible">1 star</label>
                  <input type="radio" id="first-rate2" name="review[likes]" value="2" />
                  <label for="first-rate2" title="Not good">2 stars</label>
                  <input type="radio" id="first-rate3" name="review[likes]" value="3" />
                  <label for="first-rate3" title="Average">3 stars</label>
                  <input type="radio" id="first-rate4" name="review[likes]" value="4" />
                  <label for="first-rate4" title="Very good">4 stars</label>
                  <input type="radio" id="first-rate5" name="review[likes]" value="5" />
                  <label for="first-rate5" title="Amazing">5 stars</label>
                </div>
              </div>

              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane me-2"></i>Submit Review
              </button>
            </form>
          </div>
        </div>
      <% } %>

      <!-- Reviews Section -->
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <h3 class="card-title text-primary mb-4">
            <i class="fas fa-star me-2"></i>Reviews
            <span class="badge bg-primary ms-2"><%= listing.reviews.length %> reviews</span>
          </h3>

          <% if (listing.reviews.length === 0) { %>
            <div class="text-center py-5">
              <i class="fas fa-comment-slash text-muted display-4 mb-3"></i>
              <p class="text-muted">No reviews yet. Be the first to review this place!</p>
            </div>
          <% } else { %>
            <div class="row g-4">
              <% for (let review of listing.reviews) { %>
                <div class="col-12">
                  <div class="review-card border-0 shadow-sm">
                    <div class="card-body p-4">
                      <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center gap-3">
                          <div class="avatar bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-user text-white"></i>
                          </div>
                          <div>
                            <h6 class="mb-1 fw-semibold"><%= review.author?.username || "Anonymous" %></h6>
                            <div class="star-rating">
                              <% for(let i = 1; i <= 5; i++) { %>
                                <% if(i <= review.likes) { %>
                                  <i class="fas fa-star text-warning"></i>
                                <% } else { %>
                                  <i class="far fa-star text-muted"></i>
                                <% } %>
                              <% } %>
                            </div>
                          </div>
                        </div>
                        
                        <% if (currUser && review.author && currUser._id.equals(review.author._id)) { %>
                          <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" class="d-inline">
                            <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this review?')">
                              <i class="fas fa-trash"></i>
                            </button>
                          </form>
                        <% } %>
                      </div>

                      <p class="card-text text-muted mb-0">
                        <i class="fas fa-quote-left me-2 text-primary opacity-50"></i>
                        <%= review.comment %>
                      </p>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="sticky-top" style="top: 100px;">
        <!-- Price Card -->
        <div class="card border-0 shadow-lg mb-4">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="mb-0 fw-bold text-primary">â‚¹<%= listing.price ? listing.price.toLocaleString("en-IN") : "N/A" %></h4>
              <span class="text-muted">per night</span>
            </div>
            
            <div class="d-flex flex-column gap-3">
              <button class="btn btn-primary btn-lg" id="checkAvailabilityBtn" type="button">
                <i class="fas fa-calendar-check me-2"></i>Check Availability
              </button>
              <input id="dateRangeInput" type="text" style="display:none; margin-top:10px; background:#23272f; color:#fff; border-radius:8px; border:1px solid #444; width: 180px; font-size:1rem;" placeholder="Select date range" readonly />
              <button class="btn btn-outline-primary">
                <i class="fas fa-share me-2"></i>Share
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Info -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-4">
            <h6 class="card-title text-primary mb-3">
              <i class="fas fa-list me-2"></i>Quick Info
            </h6>
            <div class="d-flex flex-column gap-2">
              <div class="d-flex justify-content-between">
                <span class="text-muted">Type:</span>
                <span class="fw-semibold">Entire Place</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-muted">Guests:</span>
                <span class="fw-semibold">4 guests</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-muted">Bedrooms:</span>
                <span class="fw-semibold">2 bedrooms</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-muted">Bathrooms:</span>
                <span class="fw-semibold">1 bathroom</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Contact Host -->
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <h6 class="card-title text-primary mb-3">
              <i class="fas fa-user me-2"></i>Contact Host
            </h6>
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="avatar bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="fas fa-user text-white"></i>
              </div>
              <div>
                <h6 class="mb-0"><%= listing.owner.username %></h6>
                <small class="text-muted">Superhost</small>
              </div>
            </div>
            <button class="btn btn-outline-primary w-100" id="messageHostBtn" data-bs-toggle="modal" data-bs-target="#messageHostModal">
              <i class="fas fa-envelope me-2"></i>Message Host
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Message Host Modal -->
<div class="modal fade" id="messageHostModal" tabindex="-1" aria-labelledby="messageHostModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="background:#23272f; color:#fff;">
      <div class="modal-header">
        <h5 class="modal-title" id="messageHostModalLabel">Message Host</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="hostMessageForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="messageText" class="form-label">Your Message</label>
            <textarea class="form-control" id="messageText" name="message" rows="4" required style="background:#23272f; color:#fff; border:1px solid #444;"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Send Message</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.listing-image {
  height: 500px;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.listing-image:hover {
  transform: scale(1.02);
}

.review-card {
  transition: all 0.3s ease;
  border-radius: 1rem;
}

.review-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.star-rating {
  font-size: 0.9rem;
}

.avatar {
  background: linear-gradient(135deg, #2563eb, #f59e0b);
}

.breadcrumb-item a:hover {
  color: #2563eb !important;
}

.card {
  border-radius: 1rem;
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
}

.btn {
  border-radius: 0.75rem;
  font-weight: 500;
  transition: all 0.3s ease;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.form-control {
  border-radius: 0.75rem;
  border: 2px solid #e2e8f0;
  transition: all 0.3s ease;
}

.form-control:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.badge {
  font-size: 0.75rem;
  padding: 0.5rem 0.75rem;
}

#calendarInput {
  max-width: 180px;
  background: #23272f;
  border: 1px solid #444;
  border-radius: 8px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.18);
  padding: 8px 10px;
  margin: 0 auto;
  z-index: 1000;
  color: #fff;
  font-size: 1rem;
}
.pika-single.dark-theme {
  background: #23272f;
  color: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.18);
  border: 1px solid #444;
}
.pika-single.dark-theme .pika-lendar {
  background: #23272f;
}
.pika-single.dark-theme .pika-day {
  color: #fff;
  border-radius: 6px;
}
.pika-single.dark-theme .is-selected .pika-day {
  background: #2563eb;
  color: #fff;
}
.pika-single.dark-theme .pika-title select {
  background: #23272f;
  color: #fff;
  border-radius: 6px;
  border: 1px solid #444;
}
.pika-single.dark-theme .pika-label {
  color: #fff;
}

#dateRangeInput {
  max-width: 180px;
  background: #23272f;
  border: 1px solid #444;
  border-radius: 8px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.18);
  padding: 8px 10px;
  margin: 0 auto;
  z-index: 1000;
  color: #fff;
  font-size: 1rem;
}
.litepicker .container__days .day-item.is-selected {
  background: #2563eb;
  color: #fff;
  border-radius: 6px;
}
.litepicker .container__days .day-item {
  border-radius: 6px;
}
.litepicker {
  background: #23272f;
  color: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.18);
  border: 1px solid #444;
}
.litepicker .container__months, .litepicker .container__days {
  background: #23272f;
  color: #fff;
}
.litepicker .month-item, .litepicker .year-item {
  background: #23272f;
  color: #fff;
}
.litepicker .button-apply {
  background: #2563eb;
  color: #fff;
  border-radius: 6px;
}

@media (max-width: 768px) {
  .listing-image {
    height: 300px;
  }
  
  .sticky-top {
    position: static !important;
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<script>
// Form validation
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();

// Smooth scrolling for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function (e) {
    e.preventDefault();
    const target = document.querySelector(this.getAttribute('href'));
    if (target) {
      target.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }
  });
});

// Like button functionality with backend connection
const likeBtn = document.getElementById('likeBtn');
const likeIcon = document.getElementById('likeIcon');
let liked = likeBtn.getAttribute('data-liked') === 'true';
likeBtn.addEventListener('click', function() {
  const listingId = likeBtn.getAttribute('data-listing-id');
  const action = liked ? 'unlike' : 'like';
  fetch('/listings/like', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({ listingId, action })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      liked = data.liked;
      if (liked) {
        likeIcon.classList.remove('text-muted');
        likeIcon.classList.add('text-danger');
      } else {
        likeIcon.classList.remove('text-danger');
        likeIcon.classList.add('text-muted');
      }
    } else {
      alert(data.message || 'Error updating like status.');
    }
  })
  .catch(() => {
    alert('Network error. Please try again.');
  });
});

// Date range picker using Litepicker
const checkBtn = document.getElementById('checkAvailabilityBtn');
const dateRangeInput = document.getElementById('dateRangeInput');
let pickerVisible = false;
let pickerInstance = null;
checkBtn.addEventListener('click', function() {
  pickerVisible = !pickerVisible;
  dateRangeInput.style.display = pickerVisible ? 'block' : 'none';
  if (pickerVisible && !pickerInstance) {
    pickerInstance = new Litepicker({
      element: dateRangeInput,
      singleMode: false,
      format: 'YYYY-MM-DD',
      minDate: new Date(),
      autoApply: true,
      numberOfMonths: 1,
      numberOfColumns: 1,
      dropdowns: {
        minYear: new Date().getFullYear(),
        maxYear: new Date().getFullYear() + 2,
        months: true,
        years: true
      },
      setup: (picker) => {
        picker.on('hide', () => {
          dateRangeInput.style.display = 'none';
          pickerVisible = false;
        });
      }
    });
    pickerInstance.show();
  } else if (pickerVisible && pickerInstance) {
    pickerInstance.show();
  } else if (!pickerVisible && pickerInstance) {
    pickerInstance.hide();
  }
});
// Message Host form submission
const hostMessageForm = document.getElementById('hostMessageForm');
hostMessageForm.addEventListener('submit', function(e) {
  e.preventDefault();
  const message = document.getElementById('messageText').value;
  fetch('/listings/<%= listing._id %>/message-host', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    body: JSON.stringify({ message })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert('Message sent to host!');
      hostMessageForm.reset();
      var modal = bootstrap.Modal.getInstance(document.getElementById('messageHostModal'));
      modal.hide();
    } else {
      alert(data.message || 'Error sending message.');
    }
  })
  .catch(() => {
    alert('Network error. Please try again.');
  });
});
</script>

